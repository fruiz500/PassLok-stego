<!DOCTYPE html>
<html lang="en" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml" manifest="passlokstego.appcache">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>PassLok stego</title>
<meta name="Keywords" content="steganography, F5, passlok, URSA, browser, encryption, decryption, symmetric, public key, signature, AES, ECDH, Diffie, Hellman, elliptic curve, advanced, javascript, PGP, PRISM">
<meta name="Description" content="PassLok Image Steganography">
<meta name="author" content="F. Ruiz">
<meta name="robots" content="index">
<meta name="viewport" content="width=device-width, minimum-scale=1, maximum-scale=1, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<link rel="apple-touch-icon" href="passlok-touch-icon.png">
<link rel="shortcut icon" type="image/x-icon" href="favicon.ico">

<!--Default CSS stylesheet containing the Light color scheme-->
<style>
html {
	-webkit-text-size-adjust: 100%;
}
body {
	font-family: Sans-Serif;
	margin-left: 1%;
	margin-right: 1%;
	overflow: auto;
	background-color: #FFFFFF;
	color: #000000;
}
.cssbutton {
	-webkit-border-radius: 10px;
	-moz-border-radius: 10px;
	border-radius: 10px;
	font-family: Arial;
	font-size: 18px;
	padding: 12px;
	text-decoration: none;
	border: 0px;
	margin-right: -2px;
	color: #666666;
	background: #e6e6e6;
}
.cssbutton:hover {
	text-decoration: none;
	cursor: pointer;
	background: #c4c4c4;
}
.cssbox {
	-webkit-border-radius: 15px;
	-moz-border-radius: 15px;
	border-radius: 15px;
	font-size: medium;
	padding: 15px;
	text-decoration: none;
	width: 100%;
	-webkit-appearance: none;
	box-sizing: border-box;
	-webkit-box-sizing: border-box;
	-moz-box-sizing: border-box;
	-webkit-box-shadow: none;
	-moz-box-shadow: none;
	box-shadow: none;
	color: #000000;
	background: #fffff5;
	border: 1px solid #dedede;
	overflow: auto;
}
.blink {
	-webkit-animation: blink .75s linear infinite;
	-moz-animation: blink .75s linear infinite;
	-ms-animation: blink .75s linear infinite;
	-o-animation: blink .75s linear infinite;
	animation: blink .75s linear infinite;
}
 @-webkit-keyframes blink {
 0% {
opacity: 1;
}
 50% {
opacity: 1;
}
 50.01% {
opacity: 0;
}
 100% {
opacity: 0;
}
}
 @-moz-keyframes blink {
 0% {
opacity: 1;
}
 50% {
opacity: 1;
}
 50.01% {
opacity: 0;
}
 100% {
opacity: 0;
}
}
 @-ms-keyframes blink {
 0% {
opacity: 1;
}
 50% {
opacity: 1;
}
 50.01% {
opacity: 0;
}
 100% {
opacity: 0;
}
}
 @-o-keyframes blink {
 0% {
opacity: 1;
}
 50% {
opacity: 1;
}
 50.01% {
opacity: 0;
}
 100% {
opacity: 0;
}
}
 @keyframes blink {
 0% {
opacity: 1;
}
 50% {
opacity: 1;
}
 50.01% {
opacity: 0;
}
 100% {
opacity: 0;
}
}
</style>

<!--License notice and SSL force-->
<script>
        /*
		@source: https://passlok.com/stego/index.html

        @licstart  The following is the entire license notice for the
        JavaScript code in this page.

        Copyright (C) 2017  Francisco Ruiz

        The JavaScript code in this page is free software: you can
        redistribute it and/or modify it under the terms of the GNU
        General Public License (GNU GPL) as published by the Free Software
        Foundation, either version 3 of the License, or (at your option)
        any later version.  The code is distributed WITHOUT ANY WARRANTY;
        without even the implied warranty of MERCHANTABILITY or FITNESS
        FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

        As additional permission under GNU GPL version 3 section 7, you
        may distribute non-source (e.g., minimized or compacted) forms of
        that code without the copy of the GNU GPL normally required by
        section 4, provided you include this license notice and a URL
        through which recipients can access the Corresponding Source.


        @licend  The above is the entire license notice
        for the JavaScript code in this page.
        */

    if (window.location.protocol == "http:") {				//force SSL/TLS

        var restOfUrl = window.location.href.substr(5);
        window.location = "https:" + restOfUrl;
    }
</script>

<!--jpeg image steganography by Owen Campbell-Moore and others. https://github.com/owencm/js-steg. First jsstegencoder-1.0.js-->
<script src="lib/jsstegencoder.js"></script>

<!--jsstegdecoder-1.0.js. Edits to display warning on error or skip over certain errors-->
<script src="lib/jsstegdecoder.js"></script>

<!--jssteg-1.0.js. Also some edits for error handling-->
<script src="lib/jssteg.js"></script>

<!--isaac seedable PRNG by Yves-Marie Rinquin. https://github.com/rubycon/isaac.js/blob/master/isaac.js-->
<script src="lib/isaac.js"></script>

<!--ORIGINAL PassLok-stego CODE, largely based on F5 by A. Westfeld 2001-->
<script src="lib/plstego.js"></script>

<!--code specific to this HTML document-->
<script>
// load image for hiding text
var importImage = function(e) {
    var reader = new FileReader();
    reader.onload = function(event) {
        // set the preview
        preview.style.display = 'block';
        document.getElementById('preview').src = event.target.result;
    }
    reader.readAsDataURL(e.target.files[0]);
	preview.onload = function(){updateCapacity()}
}

//show how much text can be hidden in the image
function updateCapacity(){
	//first measure PNG capacity. Subtract 4 bits used to encode k, 48 for the end marker
	var pngBits = Math.floor(document.getElementById('preview').naturalHeight*document.getElementById('preview').naturalWidth*3) - 52,
		textSize = b64EncodeUnicode(mainBox.value.trim()).replace(/=+$/,'').length * 6;							//text size in bits

	imageMsg.innerHTML = '<span class="blink" style="color:cyan">PROCESSING</span>';				//Get blinking message started
	setTimeout(function(){																				//give it 2 seconds to complete
		if(imageMsg.textContent == 'PROCESSING') imageMsg.textContent = 'There was an error calculating the capacity, but the image is still usable'
	},2000)	

setTimeout(function(){
	//now measure jpeg capacity
	if(document.getElementById('preview').src.slice(11,15) == 'jpeg'){					//true jpeg capacity calculation
		var lumaCoefficients = [],
			count = 0;
		jsSteg.getCoefficients(document.getElementById('preview').src, function(coefficients){
			var subSampling = 1;
			for(var index = 1; index <= 3; index++){						//first luma, then chroma channels, index 0 is always empty
				lumaCoefficients = coefficients[index];
				if(lumaCoefficients){
					if(index != 1) subSampling = Math.floor(coefficients[1].length / lumaCoefficients.length);
	 	 			for (var i = 0; i < lumaCoefficients.length; i++) {
						for (var j = 0; j < 64; j++) {
							if(lumaCoefficients[i][j] != 0) count += subSampling		//if subsampled, multiply the count since it won't be upon re-encoding
   	 					}
					}
					if(index == 1) var firstCount = count
				}else{
					count += firstCount													//repeat count if the channel appears not to exist (bug in js-steg)
				}
			}
			var jpgBits = Math.floor(count - 52);					//4 bits used to encode k, 48 for the end marker
			if(textSize <= pngBits){
				imageMsg.textContent = 'This image can hide ' + pngBits + ' bits as PNG, ' + jpgBits + ' as JPG. The box contains ' + textSize + ' bits'
			}else{
				imageMsg.textContent = 'This image can hide ' + pngBits + ' bits. But the box contains ' + textSize + ' bits'
			}
		})
	}else{															//no jpeg, so estimate capacity for a normal image
		var jpgBits = Math.floor(pngBits / 20);
		if(textSize <= pngBits){
			imageMsg.textContent = 'This image can hide ' + pngBits + ' bits as PNG, at least ' + jpgBits + ' as JPG. The box contains ' + textSize + ' bits'
		}else{
			imageMsg.textContent = 'This image can hide ' + pngBits + ' bits as PNG. But the box contains ' + textSize + ' bits'
		}
	}
},30)					//end of timeout
}

var base64 = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";

//UTF8 to base64 and back, from Mozilla Foundation
function b64EncodeUnicode(str) {
    return btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g, function(match, p1) {
        return String.fromCharCode('0x' + p1);
    }));
}

function b64DecodeUnicode(str) {
    return decodeURIComponent(atob(str).split('').map(function(c) {
        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
    }).join(''));
}

//retrieves base64 string from binary array. No error checking
function fromBin(input){
	var length = input.length - (input.length % 6)
	var output = new Array(length / 6),
		codeArray = new Array(6);
	
	for(var i = 0; i < length; i = i+6) {
		codeArray = input.slice(i,i+6);
		for(var j = 0; j < 6; j++){
			codeArray[j] = input[i+j].toString()
		}
		output[i / 6] = base64.charAt(parseInt(codeArray.join(''),2))
    }
	return output.join('')
}

//makes the binary equivalent (array) of a base64 string. No error checking
function toBin(input){
	var output = new Array(input.length * 6),
		code = '';
	
    for(var i = 0; i < input.length; i++) {
		code = ("000000" + base64.indexOf(input.charAt(i)).toString(2)).slice(-6);
		for(var j = 0; j < 6; j++){
			output[6 * i + j] = parseInt(code.charAt(j))
		}
    }
	return output
}

//function to encode mainBox into the image
function encode(){
	var text = mainBox.value.trim();

	if(!text){
		imageMsg.textContent = 'There is nothing to hide';
		throw("box empty of content")
	}
	if(preview.src.length < 100){																			//no image loaded
		imageMsg.textContent = 'Please load an image before clicking this button';
		throw("no image loaded")
	}
	imageMsg.innerHTML = '<span class="blink" style="color:cyan">PROCESSING</span>';				//Get blinking message started
	
	if(this.id == 'encodePNGBtn'){
		setTimeout(function(){
			encodePNG(preview,toBin(b64EncodeUnicode(text).replace(/=+$/,'')),imagePwd.value,function(msg){		//text is made base64 first, then a binary array
				imagePwd.value = '';
				imageMsg.textContent = msg
			});
			imagePwd.value = ''
		},10)
	}else{
		setTimeout(function(){
			encodeJPG(preview,toBin(b64EncodeUnicode(text).replace(/=+$/,'')),imagePwd.value,function(msg){
				imagePwd.value = '';
				imageMsg.textContent = msg
			});
			imagePwd.value = ''
		},10)
	}
	
	document.getElementById('preview').onload = function(){
			imageMsg.textContent = 'Text hidden in the image. Right-click to save it.'
	}
}

//extract text from the image
function decode(){	
	imageMsg.innerHTML = '<span class="blink" style="color:cyan">PROCESSING</span>';				//Get blinking message started
	
setTimeout(function(){
	decodeImage(preview,imagePwd.value,function(textBin,msg){
		mainBox.value = b64DecodeUnicode(fromBin(textBin));											//binary output turned to base64 first, then into UTF8 text
		imagePwd.value = '';
		imageMsg.textContent = msg
		})
},10)
}

//gets the histogram of an array, in this format: 0, 1, -1, 2, -2, ..., n, -n. Inputs are the array and n, output is the histogram. For testing purposes.
function getHistogram(array, n){
	var output = new Array(2*n + 2),
		length = array.length,
		counter1 = 0,
		counter2 = 0;
	
	for(var i = 0; i <= n; i++){
		counter1 = counter2 = 0;
		for(var j = 0; j < length; j++){
			if(array[j] == i) counter1++;
			if(array[j] == -i) counter2++
		}
		output[2*i] = counter1;
		output[2*i+1] = counter2
	}
	return output.slice(1)
}
</script>

</head>

<body>

<!--User interface, consisting of two panels side by side-->
<div id="leftPanel" style="width: 45%; height: 100%; float: left;">
<h3>PassLok image steganography</h3><p>&copy; F. Ruiz 2017</p>
  <button class="cssbutton" id="encodePNGBtn" value="PNG Hide" title="hide box contents into PNG image">PNG hide</button>
  &nbsp;
  <button class="cssbutton" id="encodeJPGBtn" value="JPG Hide" title="hide box contents into JPG image">JPG hide</button>
  &nbsp;
  <button class="cssbutton" id="decodeBtn" value="Reveal" title="extract hidden content and put it in the box">Reveal</button>
  &nbsp;
  <button class="cssbutton" id="clearBtn" value="Clear" title="clear box">Clear</button>
  <br />
  <br />
  <label for="imageFile" title="open dialog to select the cover image"><span class="cssbutton">Load image</span></label>
  <input type='file' id='imageFile' style="display:none;"/>
&nbsp; &nbsp;<input type="text" class="cssbox" id="imagePwd" title="use password for better undetectability" style="width:40%;padding:5px;" placeholder="optional Password"/>
  <br />
  <br />
  <textarea class="cssbox" id="mainBox" title="type what you want to hide here" placeholder="1 Type what you want to hide here. 2 Load an image with the button. 3 Click either PNG hide or JPG hide. For best results, use a Password."></textarea>
</div>
<div id="rightPanel" style="width: 50%; height: 100%; float: right;">
  <br />
  <br />
  <div id="imageMsg" style="height:30px;"></div>
  <br />
  <br />
  <img id="preview" src="" width="100%"/>
</div>

<!--Body script: window reformatting, button event listeners-->
<script>
window.onload = function() {

//resizes main box so it fits within the window
	function textHeight(){
		var	fullHeight = document.documentElement.clientHeight,
			offsetHeight = 250;
		mainBox.style.height = fullHeight - offsetHeight + 'px'
	}
	
	textHeight();
	
//event listeners for buttons etc.
	window.addEventListener('resize',textHeight);

	imageFile.addEventListener('change', importImage);
	imageFile.addEventListener('click', function(){this.value = '';});

	encodePNGBtn.addEventListener('click', encode);

	encodeJPGBtn.addEventListener('click', encode);

    decodeBtn.addEventListener('click', decode);
	
	clearBtn.addEventListener('click', function(){mainBox.value = '';});
}
</script>

</body>
</html>